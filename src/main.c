/*
 * main.c
 * Пример использования драйвера UART.
 * Демонстрация неблокирующего чтения команд.
 */

#include "uart.h"
#include <util/delay.h>

// Для Arduino Uno/Nano светодиод находится на порту PB5 (Pin 13)
#define LED_PIN 5

int main(void) {
    // 1. Настройка периферии
    UART_Init(9600); // Запуск UART
    
    // Настраиваем пин светодиода на ВЫХОД
    DDRB |= (1 << LED_PIN);

    // 2. Глобальное разрешение прерываний
    // Без этого ISR(USART_RX_vect) никогда не сработает!
    sei(); 

    UART_Print("System Online. Controls: 1=ON, 0=OFF\r\n");

    while (1) {
        // --- НЕБЛОКИРУЮЩИЙ ЦИКЛ ---
        
        // Проверяем, есть ли команды в буфере
        if (UART_Available()) {
            
            // Читаем байт (мгновенно, так как он уже в памяти)
            char c = UART_Read();

            // Парсинг команд
            if (c == '1') {
                UART_Print("--> LED ON\r\n");
                PORTB |= (1 << LED_PIN); // Включить LED
            } 
            else if (c == '0') {
                UART_Print("--> LED OFF\r\n");
                PORTB &= ~(1 << LED_PIN); // Выключить LED
            }
            else {
                // Эхо для любых других символов (для отладки)
                UART_Write(c);
            }
        }

        // Здесь процессор свободен 99.9% времени!
        // Можно добавить управление моторами, чтение датчиков и т.д.
        // Данные UART не потеряются, так как ISR сложит их в буфер.
    }
}